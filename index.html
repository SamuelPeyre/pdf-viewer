<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lecteur PDF</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: Arial, sans-serif;
            overflow: hidden;
        }
        #pdfViewerContainer {
            width: 100vw;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        #pdfControls {
            text-align: center;
            padding: 10px 0;
            flex-shrink: 0;
        }
        #pdfCanvasContainer {
            flex: 1;
            overflow: auto;
            text-align: center;
            position: relative;
            min-height: 0;
        }
        #pdfNavControls {
            text-align: center;
            padding: 10px 0 50px 0;
            flex-shrink: 0;
        }
        #errorMessage {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100vh;
            padding: 20px;
            text-align: center;
            background: #f5f5f5;
        }
        #errorMessage h1 {
            color: #e74c3c;
            font-size: 48px;
            margin-bottom: 20px;
        }
        #errorMessage p {
            color: #555;
            font-size: 18px;
            max-width: 600px;
            line-height: 1.6;
        }
        #errorMessage code {
            background: #fff;
            padding: 2px 8px;
            border-radius: 4px;
            color: #e74c3c;
            font-family: monospace;
        }
    </style>
</head>
<body>
    <div id="errorMessage" style="display:none;">
        <h1>⚠️ Aucun PDF spécifié</h1>
        <p>
            Veuillez fournir l'URL d'un PDF en utilisant le paramètre <code>?pdf=</code> dans l'URL.
        </p>
        <p style="margin-top: 20px;">
            <strong>Exemple :</strong><br>
            <code>?pdf=https://exemple.com/mon-document.pdf</code>
        </p>
    </div>

    <div id="pdfViewerContainer" style="display:none;">
        <div id="pdfControls">
            <button id="pdfZoomOut" style="border-radius:999px;padding:10px 20px;cursor:pointer;">-</button>
            <button id="pdfZoomAuto" style="border-radius:999px;padding:10px 20px;cursor:pointer;">↻ Auto</button>
            <button id="pdfZoomIn" style="border-radius:999px;padding:10px 20px;cursor:pointer;">+</button>
            <button id="pdfFullscreen" style="border-radius:999px;padding:10px 20px;cursor:pointer;">⛶ Plein écran</button>
        </div>
        <div id="pdfCanvasContainer">
            <button id="pdfArrowLeft" style="position:absolute;left:10px;top:50%;transform:translateY(-50%);background:rgba(0,0,0,0.5);color:white;border:none;border-radius:50%;width:60px;height:60px;font-size:32px;cursor:pointer;opacity:0.7;z-index:10;">‹</button>
            <canvas id="pdfCanvas"></canvas>
            <button id="pdfArrowRight" style="position:absolute;right:10px;top:50%;transform:translateY(-50%);background:rgba(0,0,0,0.5);color:white;border:none;border-radius:50%;width:60px;height:60px;font-size:32px;cursor:pointer;opacity:0.7;z-index:10;">›</button>
        </div>
        <div id="pdfNavControls">
            <button id="pdfPrevPage" style="border-radius:999px;padding:10px 20px;cursor:pointer;">← Précédent</button>
            <span id="pdfPageInfo" style="margin:0 15px;"></span>
            <button id="pdfNextPage" style="border-radius:999px;padding:10px 20px;cursor:pointer;">Suivant →</button>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
    (function() {
        const urlParams = new URLSearchParams(window.location.search);
        const pdfUrl = urlParams.get('pdf');
        
        // Vérifier si un PDF est spécifié
        if (!pdfUrl) {
            document.getElementById('errorMessage').style.display = 'flex';
            return; // Arrêter l'exécution du script
        }
        
        // Afficher le lecteur PDF
        document.getElementById('pdfViewerContainer').style.display = 'flex';
        
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        let pdfDoc = null;
        let pageNum = 1;
        let pageRendering = false;
        let pageNumPending = null;
        let scale = 1.5;
        let baseScale = 1.5;
        let maxPageWidth = 0;
        let maxPageHeight = 0;
        let userZoomAdjustment = 0;

        const canvas = document.getElementById('pdfCanvas');
        const ctx = canvas.getContext('2d');

        canvas.addEventListener('contextmenu', e => e.preventDefault());

        function renderPage(num) {
            pageRendering = true;
            pdfDoc.getPage(num).then(page => {
                // Recalculer le zoom optimal pour cette page spécifique
                const pageViewport = page.getViewport({ scale: 1 });
                maxPageWidth = pageViewport.width;
                maxPageHeight = pageViewport.height;
                calculateOptimalZoom();
                
                const viewport = page.getViewport({ scale: scale });
                canvas.height = viewport.height;
                canvas.width = viewport.width;

                const renderContext = {
                    canvasContext: ctx,
                    viewport: viewport
                };

                const renderTask = page.render(renderContext);
                renderTask.promise.then(() => {
                    pageRendering = false;
                    if (pageNumPending !== null) {
                        renderPage(pageNumPending);
                        pageNumPending = null;
                    }
                });
            });

            document.getElementById('pdfPageInfo').textContent = `Page ${num} / ${pdfDoc.numPages}`;
            document.getElementById('pdfPrevPage').disabled = (num <= 1);
            document.getElementById('pdfNextPage').disabled = (num >= pdfDoc.numPages);
        }

        function queueRenderPage(num) {
            if (pageRendering) {
                pageNumPending = num;
            } else {
                renderPage(num);
            }
        }

        function onPrevPage() {
            if (pageNum <= 1) return;
            pageNum--;
            queueRenderPage(pageNum);
        }

        function onNextPage() {
            if (pageNum >= pdfDoc.numPages) return;
            pageNum++;
            queueRenderPage(pageNum);
        }

        function zoomIn() {
            userZoomAdjustment += 0.25;
            scale = baseScale + userZoomAdjustment;
            queueRenderPage(pageNum);
        }

        function zoomOut() {
            if (scale <= 0.5) return;
            userZoomAdjustment -= 0.25;
            scale = baseScale + userZoomAdjustment;
            queueRenderPage(pageNum);
        }

        function resetZoom() {
            userZoomAdjustment = 0;
            scale = baseScale;
            queueRenderPage(pageNum);
        }

        function calculateOptimalZoom() {
            const container = document.getElementById('pdfCanvasContainer');
            const containerWidth = container.clientWidth - 40; // Marge pour les flèches
            const containerHeight = container.clientHeight - 40; // Marge de sécurité
            
            // Calculer le zoom basé sur la largeur
            const scaleByWidth = containerWidth / maxPageWidth;
            
            // Calculer le zoom basé sur la hauteur
            const scaleByHeight = containerHeight / maxPageHeight;
            
            // Prendre le plus petit des deux pour éviter tout débordement
            baseScale = Math.min(scaleByWidth, scaleByHeight, 2.0); // Maximum 2.0 pour éviter un zoom trop important
            
            scale = baseScale + userZoomAdjustment;
        }

        function toggleFullscreen() {
            const container = document.getElementById('pdfViewerContainer');
            
            if (!document.fullscreenElement) {
                container.requestFullscreen().catch(err => {
                    console.error('Erreur plein écran:', err);
                });
            } else {
                document.exitFullscreen();
            }
        }

        document.addEventListener('fullscreenchange', function() {
            const arrowLeft = document.getElementById('pdfArrowLeft');
            const arrowRight = document.getElementById('pdfArrowRight');
            const pageInfo = document.getElementById('pdfPageInfo');
            
            if (document.fullscreenElement) {
                arrowLeft.style.width = '80px';
                arrowLeft.style.height = '80px';
                arrowLeft.style.fontSize = '48px';
                arrowLeft.style.background = 'rgba(255,255,255,0.8)';
                arrowLeft.style.color = 'black';
                arrowRight.style.width = '80px';
                arrowRight.style.height = '80px';
                arrowRight.style.fontSize = '48px';
                arrowRight.style.background = 'rgba(255,255,255,0.8)';
                arrowRight.style.color = 'black';
                pageInfo.style.color = 'white';
            } else {
                arrowLeft.style.width = '60px';
                arrowLeft.style.height = '60px';
                arrowLeft.style.fontSize = '32px';
                arrowLeft.style.background = 'rgba(0,0,0,0.5)';
                arrowLeft.style.color = 'white';
                arrowRight.style.width = '60px';
                arrowRight.style.height = '60px';
                arrowRight.style.fontSize = '32px';
                arrowRight.style.background = 'rgba(0,0,0,0.5)';
                arrowRight.style.color = 'white';
                pageInfo.style.color = '';
            }
            
            setTimeout(() => {
                calculateOptimalZoom();
                queueRenderPage(pageNum);
            }, 100);
        });

        document.getElementById('pdfPrevPage').addEventListener('click', onPrevPage);
        document.getElementById('pdfNextPage').addEventListener('click', onNextPage);
        document.getElementById('pdfZoomIn').addEventListener('click', zoomIn);
        document.getElementById('pdfZoomOut').addEventListener('click', zoomOut);
        document.getElementById('pdfZoomAuto').addEventListener('click', resetZoom);
        document.getElementById('pdfFullscreen').addEventListener('click', toggleFullscreen);
        document.getElementById('pdfArrowLeft').addEventListener('click', onPrevPage);
        document.getElementById('pdfArrowRight').addEventListener('click', onNextPage);

        pdfjsLib.getDocument(pdfUrl).promise.then(pdfDoc_ => {
            pdfDoc = pdfDoc_;
            // Le zoom sera calculé automatiquement pour chaque page lors du rendu
            renderPage(pageNum);
        }).catch(err => {
            console.error('Erreur de chargement du PDF:', err);
            document.getElementById('pdfViewerContainer').style.display = 'none';
            document.getElementById('errorMessage').style.display = 'flex';
            document.getElementById('errorMessage').innerHTML = '<h1>❌ Erreur de chargement</h1><p>Impossible de charger le PDF. Vérifiez que l\'URL est correcte et accessible.</p><p style="margin-top:20px;"><code>' + pdfUrl + '</code></p>';
        });

        document.addEventListener('keydown', e => {
            if (e.key === 'ArrowLeft') onPrevPage();
            if (e.key === 'ArrowRight') onNextPage();
        });

        // Recalculer le zoom lors du redimensionnement de la fenêtre/iframe
        window.addEventListener('resize', function() {
            calculateOptimalZoom();
            queueRenderPage(pageNum);
        });
    })();
    </script>
</body>
</html>
